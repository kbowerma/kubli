<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <!-- // <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script> -->
  <!-- // <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.js"></script> -->
  <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css" rel="stylesheet">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  <script>
  function draw(data) {
    /* jshint: -W017 */

    'use strict';
    var margin = 50,
    width = 900 - margin,
    height = 300- margin;

    // use loadash filter to make a subset of data that include only moisture
    var mdata = _.filter(data, {'pin': 'T1'});
    var ldata = _.filter(data, {'pin': 'T2'});

    var value_extent = d3.extent(data,
    function(d){

      return d.value;
    }
    );

    //console.log('value_extent before ' + value_extent);
    value_extent[0] = value_extent[0] -2;
    //console.log('value_extent after ' + value_extent);


    var time_extent = d3.extent(data,
    function(d){return d.epochtime;}
    );

    var value_scale = d3.scale.linear()
    .domain(value_extent)
    .range([height, margin]);


    var time_scale = d3.time.scale()
    .domain(time_extent)
    .range([margin, width]);
    //console.log('time extends ' + time_extent );

    var time_axis = d3.svg.axis()
    .scale(time_scale);

    var count_axis = d3.svg.axis()
    .scale(value_scale)
    .orient('left');

    var line = d3.svg.line()
    .x(function(d){
      return time_scale(d.epochtime);
    })
    .y(function(d){
      return value_scale(d.value);
    })
    .interpolate('linear');

    d3.select('#mychart')
    .append('svg')
    .attr('class','chart')
    .attr('width', width+margin)
    .attr('height', height+margin);




    // generate the line for moisture
    d3.select('svg')
    .append('path')
    .attr('d', line(mdata))
    .attr('class', 'T1');

    // generate the line for light
    d3.select('svg')
    .append('path')
    .attr('d', line(ldata))
    .attr('class', 'T2');

    // generate the t1 circles
    d3.select('svg')
    .selectAll('mcircle')
    .data(mdata)
    .enter()
    .append('circle')
    .attr('class',  function(d){return d.pin;});

    // generate the t2 circles

    d3.select('svg')
    .selectAll('lcircle')
    .data(ldata)
    .enter()
    .append('circle')
    .attr('class',  function(d){return d.pin;});


    d3.selectAll('circle')
    .attr('cy', function(d){return value_scale(d.value);})
    .attr('cx', function(d){return time_scale(d.epochtime);})
    .attr('device', function(d){return d.device; })
    .attr('r', 1)
    .on('mouseover', function(d){
      d3.select(this)
      .transition()
      .attr('r',9);
    })
    .on('mouseout', function(d){
      d3.select(this)
      .transition()
      .attr('r',1);
    });



    d3.selectAll('circle.t2')
    .filter(function(d) {
      if ( d.device == 't2')
      return d;
    })
    .attr('cy', function(d){return value_scale(d.value);})
    .attr('cx', function(d){return time_scale(d.epochtime);})
    .attr('device', function(d){return d.device; })
    .attr('r', 1);

    d3.selectAll('circle')
    .on('mouseover.tooltip', function(d){
      d3.select("text." + d.pin).remove();
      d3.select('#mychart')
      .append('text')
      .text(d.pin + ' addr:' + d.device + ': ' + moment.utc(d.epochtime).local().format('ddd M/D/YY h:mm A') + ' : ' +Math.round(d.value))
      .attr('x', time_scale(d.time) +10)
      .attr('y', value_scale(d.value) - 10)
      .attr('class', d.pin)
    })

    .on('mouseout.tooltip', function(d){
      d3.select("text." + d.pin)
      .transition()
      .duration(500)
      .style('opacity',0)
      .attr('transform','translate(10, -10)')
      .remove();
    });


    d3.select('svg')
    .append('g')
    .attr('class', 'x axis')
    .attr('transform', 'translate(0,' + height + ')')
    .call(time_axis);

    d3.select('svg')
    .append('g')
    .attr('class', 'y axis')
    .attr('transform', 'translate(' + margin  + ',0)')
    .call(count_axis);

    d3.select('.y.axis')
    .append('text')
    .text('T1 and T2 degrees F '  )
    .attr('transform', 'rotate (90, ' + -margin + ', 0)')
    .attr('x', 20)
    .attr('y', -6);

    d3.select('.x.axis')
    .append('text')
    .text('time')
    .attr('x', function(){return (width / 1.6) - margin;})
    .attr('y', margin/1.5);



  }


</script>
</head>
<body>
  <div class='container'>
    <h3> Temprature T1 and T2</h3><br>

    <div class="well">
      Using data from mongo  via node server /temp, both t1 and light are shown.   Used loadash to .filter data to create two data series.



      <div id='mychart'>
        Both Temp readings in F &deg; :  T1 on Bread Board, T2 near window
      </div>


    </div>
    <script>



      //d3.json('data/yun.json', draw);
      d3.json('/temp', draw);
    </script>
  </body>
  </html>
